# é’©å­æœºåˆ¶ - æ·±å…¥æ¢è®¨

UserPromptSubmit å’Œ PreToolUse é’©å­å·¥ä½œåŸç†çš„æŠ€æœ¯æ·±å…¥æ¢è®¨ã€‚

## ç›®å½•

- [UserPromptSubmit é’©å­æµç¨‹](#userpromptsubmit-é’©å­æµç¨‹)
- [PreToolUse é’©å­æµç¨‹](#pretooluse-é’©å­æµç¨‹)
- [é€€å‡ºä»£ç è¡Œä¸ºï¼ˆå…³é”®ï¼‰](#é€€å‡ºä»£ç è¡Œä¸ºå…³é”®)
- [ä¼šè¯çŠ¶æ€ç®¡ç†](#ä¼šè¯çŠ¶æ€ç®¡ç†)
- [æ€§èƒ½è€ƒè™‘](#æ€§èƒ½è€ƒè™‘)

---

## UserPromptSubmit é’©å­æµç¨‹

### æ‰§è¡Œåºåˆ—

```
ç”¨æˆ·æäº¤æç¤º
    â†“
.claude/settings.json æ³¨å†Œé’©å­
    â†“
skill-activation-prompt.sh æ‰§è¡Œ
    â†“
npx tsx skill-activation-prompt.ts
    â†“
é’©å­è¯»å– stdinï¼ˆå¸¦æç¤ºçš„ JSONï¼‰
    â†“
åŠ è½½ skill-rules.json
    â†“
åŒ¹é…å…³é”®è¯ + æ„å›¾æ¨¡å¼
    â†“
æŒ‰ä¼˜å…ˆçº§åˆ†ç»„åŒ¹é…ï¼ˆcritical â†’ high â†’ medium â†’ lowï¼‰
    â†“
è¾“å‡ºæ ¼å¼åŒ–æ¶ˆæ¯åˆ° stdout
    â†“
stdout æˆä¸º Claude çš„ä¸Šä¸‹æ–‡ï¼ˆåœ¨æç¤ºä¹‹å‰æ³¨å…¥ï¼‰
    â†“
Claude çœ‹åˆ°ï¼š[æŠ€èƒ½å»ºè®®] + ç”¨æˆ·çš„æç¤º
```

### å…³é”®ç‚¹

- **é€€å‡ºä»£ç **ï¼šå§‹ç»ˆä¸º 0ï¼ˆå…è®¸ï¼‰
- **stdout**ï¼šâ†’ Claude çš„ä¸Šä¸‹æ–‡ï¼ˆä½œä¸ºç³»ç»Ÿæ¶ˆæ¯æ³¨å…¥ï¼‰
- **æ—¶æœº**ï¼šåœ¨ Claude å¤„ç†æç¤ºä¹‹å‰è¿è¡Œ
- **è¡Œä¸º**ï¼šéé˜»å¡ï¼Œä»…å»ºè®®
- **ç›®çš„**ï¼šä½¿ Claude çŸ¥æ™“ç›¸å…³æŠ€èƒ½

### è¾“å…¥æ ¼å¼

```json
{
  "session_id": "abc-123",
  "transcript_path": "/path/to/transcript.json",
  "cwd": "/root/git/your-project",
  "permission_mode": "normal",
  "hook_event_name": "UserPromptSubmit",
  "prompt": "how does the layout system work?"
}
```

### è¾“å‡ºæ ¼å¼ï¼ˆåˆ° stdoutï¼‰

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¯ SKILL ACTIVATION CHECK
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“š RECOMMENDED SKILLS:
  â†’ project-catalog-developer

ACTION: Use Skill tool BEFORE responding
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

Claude åœ¨å¤„ç†ç”¨æˆ·æç¤ºä¹‹å‰å°†æ­¤è¾“å‡ºè§†ä¸ºé™„åŠ ä¸Šä¸‹æ–‡ã€‚

---

## PreToolUse é’©å­æµç¨‹

### æ‰§è¡Œåºåˆ—

```
Claude è°ƒç”¨ Edit/Write å·¥å…·
    â†“
.claude/settings.json æ³¨å†Œé’©å­ï¼ˆåŒ¹é…å™¨ï¼šEdit|Writeï¼‰
    â†“
skill-verification-guard.sh æ‰§è¡Œ
    â†“
npx tsx skill-verification-guard.ts
    â†“
é’©å­è¯»å– stdinï¼ˆå¸¦ tool_nameã€tool_input çš„ JSONï¼‰
    â†“
åŠ è½½ skill-rules.json
    â†“
æ£€æŸ¥æ–‡ä»¶è·¯å¾„æ¨¡å¼ï¼ˆglob åŒ¹é…ï¼‰
    â†“
è¯»å–æ–‡ä»¶çš„å†…å®¹æ¨¡å¼ï¼ˆå¦‚æœæ–‡ä»¶å­˜åœ¨ï¼‰
    â†“
æ£€æŸ¥ä¼šè¯çŠ¶æ€ï¼ˆæŠ€èƒ½å·²ä½¿ç”¨ï¼Ÿï¼‰
    â†“
æ£€æŸ¥è·³è¿‡æ¡ä»¶ï¼ˆæ–‡ä»¶æ ‡è®°ã€ç¯å¢ƒå˜é‡ï¼‰
    â†“
å¦‚æœåŒ¹é…ä¸”æœªè·³è¿‡ï¼š
  æ›´æ–°ä¼šè¯çŠ¶æ€ï¼ˆæ ‡è®°æŠ€èƒ½ä¸ºå·²æ‰§è¡Œï¼‰
  è¾“å‡ºé˜»æ­¢æ¶ˆæ¯åˆ° stderr
  é€€å‡ºä»£ç  2ï¼ˆé˜»æ­¢ï¼‰
å¦åˆ™ï¼š
  é€€å‡ºä»£ç  0ï¼ˆå…è®¸ï¼‰
    â†“
å¦‚æœè¢«é˜»æ­¢ï¼š
  stderr â†’ Claude çœ‹åˆ°æ¶ˆæ¯
  Edit/Write å·¥å…·ä¸æ‰§è¡Œ
  Claude å¿…é¡»ä½¿ç”¨æŠ€èƒ½å¹¶é‡è¯•
å¦‚æœå…è®¸ï¼š
  å·¥å…·æ­£å¸¸æ‰§è¡Œ
```

### å…³é”®ç‚¹

- **é€€å‡ºä»£ç  2**ï¼šé˜»æ­¢ï¼ˆstderr â†’ Claudeï¼‰
- **é€€å‡ºä»£ç  0**ï¼šå…è®¸
- **æ—¶æœº**ï¼šåœ¨å·¥å…·æ‰§è¡Œä¹‹å‰è¿è¡Œ
- **ä¼šè¯è·Ÿè¸ª**ï¼šé˜²æ­¢åŒä¸€ä¼šè¯ä¸­é‡å¤é˜»æ­¢
- **å¼€æ”¾å¤±è´¥**ï¼šå‡ºé”™æ—¶å…è®¸æ“ä½œï¼ˆä¸ç ´åå·¥ä½œæµç¨‹ï¼‰
- **ç›®çš„**ï¼šæ‰§è¡Œå…³é”®é˜²æŠ¤æ 

### è¾“å…¥æ ¼å¼

```json
{
  "session_id": "abc-123",
  "transcript_path": "/path/to/transcript.json",
  "cwd": "/root/git/your-project",
  "permission_mode": "normal",
  "hook_event_name": "PreToolUse",
  "tool_name": "Edit",
  "tool_input": {
    "file_path": "/root/git/your-project/form/src/services/user.ts",
    "old_string": "...",
    "new_string": "..."
  }
}
```

### è¾“å‡ºæ ¼å¼ï¼ˆè¢«é˜»æ­¢æ—¶åˆ° stderrï¼‰

```
âš ï¸ BLOCKED - Database Operation Detected

ğŸ“‹ REQUIRED ACTION:
1. Use Skill tool: 'database-verification'
2. Verify ALL table and column names against schema
3. Check database structure with DESCRIBE commands
4. Then retry this edit

Reason: Prevent column name errors in Prisma queries
File: form/src/services/user.ts

ğŸ’¡ TIP: Add '// @skip-validation' comment to skip future checks
```

Claude æ”¶åˆ°æ­¤æ¶ˆæ¯å¹¶ç†è§£éœ€è¦åœ¨é‡è¯•ç¼–è¾‘ä¹‹å‰ä½¿ç”¨æŠ€èƒ½ã€‚

---

## é€€å‡ºä»£ç è¡Œä¸ºï¼ˆå…³é”®ï¼‰

### é€€å‡ºä»£ç å‚è€ƒè¡¨

| é€€å‡ºä»£ç  | stdout | stderr | å·¥å…·æ‰§è¡Œ | Claude çœ‹åˆ° |
|---------|--------|--------|---------|------------|
| 0 (UserPromptSubmit) | â†’ ä¸Šä¸‹æ–‡ | â†’ ä»…ç”¨æˆ· | N/A | stdout å†…å®¹ |
| 0 (PreToolUse) | â†’ ä»…ç”¨æˆ· | â†’ ä»…ç”¨æˆ· | **ç»§ç»­** | æ—  |
| 2 (PreToolUse) | â†’ ä»…ç”¨æˆ· | â†’ **CLAUDE** | **é˜»æ­¢** | stderr å†…å®¹ |
| å…¶ä»– | â†’ ä»…ç”¨æˆ· | â†’ ä»…ç”¨æˆ· | é˜»æ­¢ | æ—  |

### ä¸ºä»€ä¹ˆé€€å‡ºä»£ç  2 å¾ˆé‡è¦

è¿™æ˜¯æ‰§è¡Œçš„å…³é”®æœºåˆ¶ï¼š

1. ä» PreToolUse å‘ Claude å‘é€æ¶ˆæ¯çš„**å”¯ä¸€æ–¹å¼**
2. stderr å†…å®¹"è‡ªåŠ¨åé¦ˆç»™ Claude"
3. Claude çœ‹åˆ°é˜»æ­¢æ¶ˆæ¯å¹¶ç†è§£è¯¥åšä»€ä¹ˆ
4. å·¥å…·æ‰§è¡Œè¢«é˜»æ­¢
5. å¯¹é˜²æŠ¤æ æ‰§è¡Œè‡³å…³é‡è¦

### å¯¹è¯æµç¨‹ç¤ºä¾‹

```
ç”¨æˆ·ï¼š"ä½¿ç”¨ Prisma æ·»åŠ æ–°çš„ç”¨æˆ·æœåŠ¡"

Claudeï¼š"æˆ‘å°†åˆ›å»ºç”¨æˆ·æœåŠ¡..."
    [å°è¯•ç¼–è¾‘ form/src/services/user.ts]

PreToolUse é’©å­ï¼š[é€€å‡ºä»£ç  2]
    stderrï¼š"âš ï¸ BLOCKED - Use database-verification"

Claude çœ‹åˆ°é”™è¯¯ï¼Œå“åº”ï¼š
    "æˆ‘éœ€è¦å…ˆéªŒè¯æ•°æ®åº“æ¨¡å¼ã€‚"
    [ä½¿ç”¨ Skill å·¥å…·ï¼šdatabase-verification]
    [éªŒè¯åˆ—å]
    [é‡è¯•ç¼–è¾‘ - ç°åœ¨å…è®¸ï¼ˆä¼šè¯è·Ÿè¸ªï¼‰]
```

---

## ä¼šè¯çŠ¶æ€ç®¡ç†

### ç›®çš„

é˜²æ­¢åŒä¸€ä¼šè¯ä¸­é‡å¤æé†’ - ä¸€æ—¦ Claude ä½¿ç”¨æŠ€èƒ½ï¼Œä¸å†é˜»æ­¢ã€‚

### çŠ¶æ€æ–‡ä»¶ä½ç½®

`.claude/hooks/state/skills-used-{session_id}.json`

### çŠ¶æ€æ–‡ä»¶ç»“æ„

```json
{
  "skills_used": [
    "database-verification",
    "error-tracking"
  ],
  "files_verified": []
}
```

### å·¥ä½œåŸç†

1. **é¦–æ¬¡ç¼–è¾‘**å¸¦ Prisma çš„æ–‡ä»¶ï¼š
   - é’©å­ä½¿ç”¨é€€å‡ºä»£ç  2 é˜»æ­¢
   - æ›´æ–°ä¼šè¯çŠ¶æ€ï¼šå°† "database-verification" æ·»åŠ åˆ° skills_used
   - Claude çœ‹åˆ°æ¶ˆæ¯ï¼Œä½¿ç”¨æŠ€èƒ½

2. **ç¬¬äºŒæ¬¡ç¼–è¾‘**ï¼ˆåŒä¸€ä¼šè¯ï¼‰ï¼š
   - é’©å­æ£€æŸ¥ä¼šè¯çŠ¶æ€
   - åœ¨ skills_used ä¸­æ‰¾åˆ° "database-verification"
   - é€€å‡ºä»£ç  0ï¼ˆå…è®¸ï¼‰
   - ä¸å‘ Claude å‘é€æ¶ˆæ¯

3. **ä¸åŒä¼šè¯**ï¼š
   - æ–°ä¼šè¯ ID = æ–°çŠ¶æ€æ–‡ä»¶
   - é’©å­å†æ¬¡é˜»æ­¢

### é™åˆ¶

é’©å­æ— æ³•æ£€æµ‹æŠ€èƒ½ä½•æ—¶*å®é™…*è¢«è°ƒç”¨ - å®ƒåªæ˜¯æ¯ä¸ªä¼šè¯æ¯ä¸ªæŠ€èƒ½é˜»æ­¢ä¸€æ¬¡ã€‚è¿™æ„å‘³ç€ï¼š

- å¦‚æœ Claude ä¸ä½¿ç”¨æŠ€èƒ½ä½†è¿›è¡Œä¸åŒçš„ç¼–è¾‘ï¼Œå®ƒä¸ä¼šå†æ¬¡é˜»æ­¢
- ç›¸ä¿¡ Claude ä¼šéµå¾ªæŒ‡ä»¤
- æœªæ¥å¢å¼ºï¼šæ£€æµ‹å®é™…çš„ Skill å·¥å…·ä½¿ç”¨

---

## æ€§èƒ½è€ƒè™‘

### ç›®æ ‡æŒ‡æ ‡

- **UserPromptSubmit**ï¼š< 100ms
- **PreToolUse**ï¼š< 200ms

### æ€§èƒ½ç“¶é¢ˆ

1. **åŠ è½½ skill-rules.json**ï¼ˆæ¯æ¬¡æ‰§è¡Œï¼‰
   - æœªæ¥ï¼šåœ¨å†…å­˜ä¸­ç¼“å­˜
   - æœªæ¥ï¼šç›‘å¬æ›´æ”¹ï¼Œä»…åœ¨éœ€è¦æ—¶é‡æ–°åŠ è½½

2. **è¯»å–æ–‡ä»¶å†…å®¹**ï¼ˆPreToolUseï¼‰
   - ä»…åœ¨é…ç½® contentPatterns æ—¶
   - ä»…å½“æ–‡ä»¶å­˜åœ¨æ—¶
   - å¤§æ–‡ä»¶å¯èƒ½å¾ˆæ…¢

3. **Glob åŒ¹é…**ï¼ˆPreToolUseï¼‰
   - ä¸ºæ¯ä¸ªæ¨¡å¼ç¼–è¯‘æ­£åˆ™è¡¨è¾¾å¼
   - æœªæ¥ï¼šç¼–è¯‘ä¸€æ¬¡ï¼Œç¼“å­˜

4. **æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…**ï¼ˆä¸¤ä¸ªé’©å­ï¼‰
   - æ„å›¾æ¨¡å¼ï¼ˆUserPromptSubmitï¼‰
   - å†…å®¹æ¨¡å¼ï¼ˆPreToolUseï¼‰
   - æœªæ¥ï¼šå»¶è¿Ÿç¼–è¯‘ï¼Œç¼“å­˜ç¼–è¯‘çš„æ­£åˆ™è¡¨è¾¾å¼

### ä¼˜åŒ–ç­–ç•¥

**å‡å°‘æ¨¡å¼ï¼š**
- ä½¿ç”¨æ›´å…·ä½“çš„æ¨¡å¼ï¼ˆæ£€æŸ¥æ›´å°‘ï¼‰
- å°½å¯èƒ½åˆå¹¶ç±»ä¼¼æ¨¡å¼

**æ–‡ä»¶è·¯å¾„æ¨¡å¼ï¼š**
- æ›´å…·ä½“ = æ£€æŸ¥æ›´å°‘çš„æ–‡ä»¶
- ç¤ºä¾‹ï¼š`form/src/services/**` å¥½äº `form/**`

**å†…å®¹æ¨¡å¼ï¼š**
- ä»…åœ¨çœŸæ­£å¿…è¦æ—¶æ·»åŠ 
- æ›´ç®€å•çš„æ­£åˆ™è¡¨è¾¾å¼ = æ›´å¿«çš„åŒ¹é…

---

**ç›¸å…³æ–‡ä»¶ï¼š**
- [SKILL.md](SKILL.md) - ä¸»æŠ€èƒ½æŒ‡å—
- [TROUBLESHOOTING.md](TROUBLESHOOTING.md) - è°ƒè¯•é’©å­é—®é¢˜
- [SKILL_RULES_REFERENCE.md](SKILL_RULES_REFERENCE.md) - é…ç½®å‚è€ƒ
